# ========================================
# Speak and Shine 2025 PHP-FPM 설정
# ========================================
# 
# 이 설정을 /etc/php/8.2/fpm/pool.d/storytelling.conf에 추가하거나
# 기존 www.conf 파일을 수정하세요.
#

[storytelling]
user = www-data
group = www-data

# 소켓 설정
listen = /run/php/php8.2-fpm-storytelling.sock
listen.owner = www-data
listen.group = www-data
listen.mode = 0660

# 프로세스 관리
pm = dynamic
pm.max_children = 50
pm.start_servers = 5
pm.min_spare_servers = 5
pm.max_spare_servers = 35
pm.max_requests = 500

# 메모리 및 실행 시간 설정 (대용량 파일 업로드용)
php_admin_value[memory_limit] = 2048M
php_admin_value[upload_max_filesize] = 2048M
php_admin_value[post_max_size] = 2048M
php_admin_value[max_execution_time] = 0
php_admin_value[max_input_time] = 3600

# 입출력 타임아웃
php_admin_value[default_socket_timeout] = 3600
php_admin_value[mysql.connect_timeout] = 3600

# 파일 업로드 설정
php_admin_value[file_uploads] = On
php_admin_value[max_file_uploads] = 20

# 오류 처리 (프로덕션 환경)
php_admin_value[display_errors] = Off
php_admin_value[log_errors] = On
php_admin_value[error_log] = /var/log/php_errors.log

# 세션 설정
php_admin_value[session.save_handler] = files
php_admin_value[session.save_path] = /var/lib/php/sessions
php_admin_value[session.gc_maxlifetime] = 7200

# OPcache 설정 (성능 향상)
php_admin_value[opcache.enable] = 1
php_admin_value[opcache.memory_consumption] = 256
php_admin_value[opcache.interned_strings_buffer] = 16
php_admin_value[opcache.max_accelerated_files] = 10000
php_admin_value[opcache.revalidate_freq] = 2
php_admin_value[opcache.fast_shutdown] = 1

# 보안 설정
php_admin_value[expose_php] = Off
php_admin_value[allow_url_fopen] = Off
php_admin_value[allow_url_include] = Off

# 환경 변수
env[HOSTNAME] = $HOSTNAME
env[PATH] = /usr/local/bin:/usr/bin:/bin
env[TMP] = /tmp
env[TMPDIR] = /tmp
env[TEMP] = /tmp
