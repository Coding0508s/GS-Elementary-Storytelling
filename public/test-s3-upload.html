<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 직접 업로드 테스트</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3>S3 직접 업로드 테스트</h3>
                    </div>
                    <div class="card-body">
                        <form id="test-form">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="test-institution" class="form-label">기관명</label>
                                    <input type="text" class="form-control" id="test-institution" placeholder="예: 용인000" value="용인테스트">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="test-student" class="form-label">학생 이름</label>
                                    <input type="text" class="form-control" id="test-student" placeholder="예: 김철수" value="김테스트">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="test-grade" class="form-label">학년</label>
                                    <input type="text" class="form-control" id="test-grade" placeholder="예: 1학년" value="1학년">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="test-file" class="form-label">테스트 파일 선택</label>
                                <input type="file" class="form-control" id="test-file" accept="video/*">
                            </div>
                            <button type="submit" class="btn btn-primary">업로드 테스트</button>
                        </form>
                        
                        <div id="progress" class="mt-3" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="mt-2">
                                <span id="progress-text">0%</span>
                            </div>
                        </div>
                        
                        <div id="result" class="mt-3" style="display: none;">
                            <div class="alert alert-success">
                                <h5>업로드 완료!</h5>
                                <p id="result-text"></p>
                            </div>
                        </div>
                        
                        <div id="error" class="mt-3" style="display: none;">
                            <div class="alert alert-danger">
                                <h5>업로드 실패!</h5>
                                <p id="error-text"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ asset('js/s3-upload.js') }}"></script>
    <script>
        document.getElementById('test-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('test-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('파일을 선택해주세요.');
                return;
            }
            
            const progressDiv = document.getElementById('progress');
            const progressBar = document.querySelector('.progress-bar');
            const progressText = document.getElementById('progress-text');
            const resultDiv = document.getElementById('result');
            const resultText = document.getElementById('result-text');
            const errorDiv = document.getElementById('error');
            const errorText = document.getElementById('error-text');
            
            // UI 초기화
            progressDiv.style.display = 'block';
            resultDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            
            try {
                const s3Uploader = new S3DirectUpload();
                
                // 사용자 정보 수집
                const userInfo = {
                    institution_name: document.getElementById('test-institution').value,
                    student_name_korean: document.getElementById('test-student').value,
                    grade: document.getElementById('test-grade').value
                };
                
                const result = await s3Uploader.uploadFile(
                    file,
                    // 진행률 콜백
                    (progress) => {
                        progressBar.style.width = progress.percent + '%';
                        progressText.textContent = Math.round(progress.percent) + '%';
                    },
                    // 완료 콜백
                    (result) => {
                        console.log('업로드 완료:', result);
                    },
                    // 오류 콜백
                    (error) => {
                        console.error('업로드 오류:', error);
                        throw error;
                    },
                    // 사용자 정보 전달
                    userInfo
                );
                
                progressDiv.style.display = 'none';
                resultDiv.style.display = 'block';
                resultText.innerHTML = `
                    <strong>S3 Key:</strong> ${result.s3_key}<br>
                    <strong>URL:</strong> <a href="${result.url}" target="_blank">${result.url}</a><br>
                    <strong>파일명:</strong> ${file.name}<br>
                    <strong>크기:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB
                `;
                
            } catch (error) {
                progressDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                errorText.textContent = error.message;
                console.error('업로드 실패:', error);
            }
        });
    </script>
</body>
</html>
